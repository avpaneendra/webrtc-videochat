<!DOCTYPE html>
<html>
	<head>

		<meta name='keywords' content ='WebRTC, HTML5, JavaScript' />
		<meta name='description' content='WebRTC' />
		<meta name='viewport' content='width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1'>
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="stylesheet" type="text/css" href="/css/mainpage.css">
		<base target='_blank'>

		<title>WebRTC client</title>
		<script src="/mainrtc.js"></script>
		<script src="/js/constraints.js"></script>
		<script src="/js/adapter.js"></script>
		<script src="/js/socketTool.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script src="/js/firebase.js"></script>


	</head>

	<body>
		<div class="auth">
				<label id="user_login"></label>
				<button class="google" id="google_state" onclick="toggleAuth()">Sign In</button>
		</div>
		<div class="userLogin">
			<input id="userLoginInput" type="text" name="message" placeholder="Your name"/>
			<input id="userLoginBtn" type="submit" value="login >>>" onclick="">
		</div>
		<div class="userVideo">

				<video id = "remote" style="width:40%;" autoplay></video>

			<div id="localWrap">
				<video id = "local" style="width:20%" muted autoplay></video>
			</div>
			<canvas ></canvas>
		</div>
		<div class="userControl">
			<input id="userNameRemoteInput" type="text" name="message" placeholder="Call to.."/>
			<input  id="userCallRemoteBtn" value="Call" type="submit" onclick="">
			<input  id="userHangUpBtn" value="Hang up" type="submit" onclick="">
			<input id="userSelfieBtn" type="submit" value="Selfie" >
		</div>

		<script src="/js/UI.js"></script>
		<script src="/js/connectionP2P.js"></script>

		<script>
			function toggleAuth(){
				if(!firebase.auth().currentUser){
					var provider = new firebase.auth.GoogleAuthProvider();
					firebase.auth().signInWithPopup(provider).then(function(result) {
						var token = result.credential.accessToken;
						var user = result.user;
						send(JSON.stringify({type: "login", name: user.displayName}));
						console.log(user.displayName);
					}).catch(function(error) {
						console.error(error);
					});
				} else {
					firebase.auth().signOut();
					console.log("logout",firebase.auth().currentUser.displayName);
				}
			}
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					document.getElementById('google_state').textContent = 'Sign Out';
					document.getElementById('user_login').textContent = user.displayName;
				} else {
					document.getElementById('google_state').textContent = 'Sign In';
					document.getElementById('user_login').textContent = "";
				}
			});
			var socket = io.connect(), connectedUser, userLogin = {};
			mainrtc.UI.initInterface();
			socket.on('message', socketEventHandler);

			function send(message){
				if (connectedUser) message.name = connectedUser;
				socket.send(message);
			}
			function socketEventHandler(msg){
				var json = mainrtc.socketTool.isJson(msg);
				var data;
				if(json) data = JSON.parse(msg);
				else data.type = {jsonError:"Json error"};

				switch(data.type){
					case 'login':
						onLogin(data);
						break;
					case 'candidate':
						mainrtc.connectionP2P.onCandidate(data.candidate);
						break;
					case 'offer':
						mainrtc.connectionP2P.onOffer(data.offer, data.name);
						break;
					case 'answer':
						mainrtc.connectionP2P.onAnswer(data.answer, data.name);
						break;
					case 'leave':
						mainrtc.connectionP2P.onLeave();
						break;
					default:
						break;
				}
			}
			function onLogin(data){
				if(!data.success) {
					alert("Try new login: "+ data.name);
				} else {
					console.log("login success: " + data.name);
					mainrtc.connectionP2P.startConnection();
				}
			}
		</script>
	</body>
</html>
